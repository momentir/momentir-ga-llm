<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프롬프트 관리 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #2f3640;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        #memo-input {
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .results-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .success {
            border-left: 4px solid #2ecc71;
            background-color: #d5f4e6;
        }

        .error {
            border-left: 4px solid #e74c3c;
            background-color: #ffeaea;
        }

        .prompt-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .prompt-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .prompt-item:hover {
            background-color: #e9ecef;
        }

        .prompt-item:last-child {
            border-bottom: none;
        }

        .prompt-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-weight: 600;
        }

        .prompt-item.selected:hover {
            background-color: #e3f2fd;
        }

        .prompt-meta {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #2ecc71;
        }

        .status-inactive {
            background: #95a5a6;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 프롬프트 관리 시스템</h1>
            <p>메모 정제 API를 위한 프롬프트를 관리하고 테스트해보세요</p>
        </div>

        <div class="main-content">
            <!-- 프롬프트 관리 섹션 -->
            <div class="card">
                <h2>📝 프롬프트 관리</h2>
                
                <div class="form-group">
                    <label for="prompt-name">프롬프트 이름</label>
                    <input type="text" id="prompt-name" placeholder="예: 기본 메모 분석 프롬프트">
                </div>

                <div class="form-group">
                    <label for="prompt-content">프롬프트 내용</label>
                    <textarea id="prompt-content" placeholder="프롬프트를 입력하세요..."></textarea>
                </div>

                <div class="form-group">
                    <button class="btn" onclick="saveNewPrompt()">💾 새 프롬프트 저장</button>
                    <button class="btn btn-success" id="update-btn" onclick="updatePrompt()" style="display: none;">✏️ 프롬프트 수정</button>
                    <button class="btn btn-secondary" onclick="clearPrompt()">🔄 초기화</button>
                    <button class="btn btn-secondary" onclick="loadDefaultPrompt()">📋 기본 템플릿</button>
                </div>

                <div class="form-group">
                    <h3>저장된 프롬프트 목록</h3>
                    <div class="prompt-list" id="prompt-list">
                        <div class="loading" id="prompt-loading">
                            <div class="spinner"></div>
                            로딩 중...
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="loadPrompts()" style="margin-top: 10px;">📂 목록 새로고침</button>
                    <button class="btn btn-secondary" onclick="debugStorage()" style="margin-top: 10px;">🔍 저장소 상태 확인</button>
                </div>
            </div>

            <!-- 테스트 섹션 -->
            <div class="card">
                <h2>🧪 프롬프트 테스트</h2>
                
                <div class="form-group">
                    <label for="memo-input">테스트용 메모 내용</label>
                    <textarea id="memo-input" placeholder="테스트할 메모 내용을 입력하세요...
예: 고객이 전화로 보험료 인상에 대해 문의함. 2주 후 다시 연락하기로 함. 현재 자동차보험에 가입되어 있고 화재보험도 관심있어함."></textarea>
                </div>

                <div class="form-group">
                    <button class="btn btn-success" onclick="testPrompt()">🚀 실행</button>
                    <button class="btn btn-secondary" onclick="clearResults()">🗑️ 결과 초기화</button>
                </div>

                <div class="loading" id="test-loading">
                    <div class="spinner"></div>
                    AI가 메모를 분석 중입니다...
                </div>
            </div>
        </div>

        <!-- 결과 섹션 -->
        <div class="results-section">
            <div class="card">
                <h2>📊 실행 결과</h2>
                <div id="result-container">
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        프롬프트를 실행하면 결과가 여기에 표시됩니다.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let savedPrompts = [];
        let currentPromptId = null;

        // 기본 프롬프트 템플릿
        const DEFAULT_PROMPT = `당신은 보험회사의 고객 메모를 분석하는 전문가입니다.
고객 메모에서 다음 정보를 정확하게 추출해주세요:

다음 JSON 형식으로 응답해주세요:
{
  "summary": "메모 요약",
  "status": "고객 상태/감정",
  "keywords": ["키워드1", "키워드2"],
  "time_expressions": [
    {"expression": "2주 후", "parsed_date": "2024-01-15"}
  ],
  "required_actions": ["필요한 후속 조치"],
  "insurance_info": {
    "products": ["현재 가입 상품"],
    "premium_amount": "보험료 정보",
    "interest_products": ["관심 상품"],
    "policy_changes": ["보험 변경사항"]
  }
}`;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultPrompt();
            loadPrompts();
        });

        // 기본 프롬프트 로드
        function loadDefaultPrompt() {
            document.getElementById('prompt-content').value = DEFAULT_PROMPT;
            document.getElementById('prompt-name').value = '기본 메모 분석 프롬프트';
            currentPromptId = null;
            updateButtonVisibility();
        }

        // 버튼 가시성 업데이트
        function updateButtonVisibility() {
            const updateBtn = document.getElementById('update-btn');
            if (currentPromptId) {
                updateBtn.style.display = 'inline-block';
            } else {
                updateBtn.style.display = 'none';
            }
        }

        // 새 프롬프트 저장
        async function saveNewPrompt() {
            console.log('saveNewPrompt() 호출됨');
            const name = document.getElementById('prompt-name').value.trim();
            const content = document.getElementById('prompt-content').value.trim();

            if (!name || !content) {
                showResult('프롬프트 이름과 내용을 모두 입력해주세요.', 'error');
                return;
            }

            try {
                // 로컬 스토리지에서 기존 데이터 로드
                const stored = localStorage.getItem('savedPrompts');
                savedPrompts = stored ? JSON.parse(stored) : [];
                
                // 항상 새로운 ID로 프롬프트 생성
                const promptId = Date.now().toString();
                const prompt = {
                    id: promptId,
                    name: name,
                    content: content,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                savedPrompts.push(prompt);
                console.log('새 프롬프트 생성:', prompt.name);

                localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
                
                showResult(`새 프롬프트 "${name}"이(가) 저장되었습니다.`, 'success');
                
                // 목록 자동 새로고침
                loadPrompts();
                
                // 저장된 프롬프트를 현재 선택으로 설정
                currentPromptId = promptId;
                updateButtonVisibility();
                
            } catch (error) {
                console.error('새 프롬프트 저장 중 오류:', error);
                showResult('새 프롬프트 저장 중 오류가 발생했습니다.', 'error');
            }
        }

        // 기존 프롬프트 수정
        async function updatePrompt() {
            console.log('updatePrompt() 호출됨');
            const name = document.getElementById('prompt-name').value.trim();
            const content = document.getElementById('prompt-content').value.trim();

            if (!name || !content) {
                showResult('프롬프트 이름과 내용을 모두 입력해주세요.', 'error');
                return;
            }

            if (!currentPromptId) {
                showResult('수정할 프롬프트가 선택되지 않았습니다.', 'error');
                return;
            }

            try {
                // 로컬 스토리지에서 기존 데이터 로드
                const stored = localStorage.getItem('savedPrompts');
                savedPrompts = stored ? JSON.parse(stored) : [];
                
                const existingIndex = savedPrompts.findIndex(p => p.id === currentPromptId);
                
                if (existingIndex >= 0) {
                    // 기존 프롬프트 수정 - created_at 유지
                    const prompt = {
                        ...savedPrompts[existingIndex],
                        name: name,
                        content: content,
                        updated_at: new Date().toISOString()
                    };
                    savedPrompts[existingIndex] = prompt;
                    console.log('기존 프롬프트 수정:', prompt.name);

                    localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
                    
                    showResult(`프롬프트 "${name}"이(가) 수정되었습니다.`, 'success');
                    
                    // 목록 자동 새로고침
                    loadPrompts();
                } else {
                    showResult('수정할 프롬프트를 찾을 수 없습니다.', 'error');
                }
                
            } catch (error) {
                console.error('프롬프트 수정 중 오류:', error);
                showResult('프롬프트 수정 중 오류가 발생했습니다.', 'error');
            }
        }

        // 저장된 프롬프트 목록 로드
        function loadPrompts() {
            console.log('loadPrompts() 호출됨');
            
            // DOM이 완전히 로드될 때까지 대기
            if (document.readyState !== 'complete') {
                console.log('DOM이 아직 로드 중입니다. 잠시 후 재시도...');
                setTimeout(loadPrompts, 100);
                return;
            }
            
            const listEl = document.getElementById('prompt-list');
            
            if (!listEl) {
                console.error('prompt-list 요소를 찾을 수 없습니다');
                return;
            }
            
            // 로딩 요소가 없으면 동적으로 생성
            let loadingEl = document.getElementById('prompt-loading');
            if (!loadingEl) {
                console.log('prompt-loading 요소가 없어서 동적으로 생성합니다');
                loadingEl = document.createElement('div');
                loadingEl.id = 'prompt-loading';
                loadingEl.className = 'loading';
                loadingEl.innerHTML = '<div class="spinner"></div>로딩 중...';
                listEl.appendChild(loadingEl);
            }
            
            console.log('DOM 요소 확인:', {
                loadingEl: !!loadingEl,
                listEl: !!listEl,
                loadingElId: loadingEl?.id,
                listElId: listEl?.id
            });
            
            // 로딩 표시
            loadingEl.classList.add('show');
            
            // 짧은 지연 후 실행 (UI 반응성을 위해)
            setTimeout(() => {
                try {
                    const stored = localStorage.getItem('savedPrompts');
                    savedPrompts = stored ? JSON.parse(stored) : [];
                    console.log('저장된 프롬프트 개수:', savedPrompts.length);
                    
                    // 기존 프롬프트 아이템들만 제거 (로딩 요소는 보존)
                    const promptItems = listEl.querySelectorAll('.prompt-item');
                    promptItems.forEach(item => item.remove());
                    
                    // 기존 메시지들 제거
                    const messages = listEl.querySelectorAll('div:not(.loading):not(#prompt-loading)');
                    messages.forEach(msg => {
                        if (!msg.classList.contains('prompt-item') && msg.id !== 'prompt-loading') {
                            msg.remove();
                        }
                    });
                    
                    if (savedPrompts.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.style.cssText = 'padding: 20px; text-align: center; color: #6c757d;';
                        emptyMessage.textContent = '저장된 프롬프트가 없습니다.';
                        listEl.appendChild(emptyMessage);
                    } else {
                        savedPrompts.forEach((prompt, index) => {
                            console.log(`프롬프트 ${index + 1}: ${prompt.name}`);
                            const item = document.createElement('div');
                            item.className = 'prompt-item';
                            item.dataset.promptId = prompt.id;
                            
                            // 현재 선택된 프롬프트인지 확인하여 selected 클래스 추가
                            if (currentPromptId && currentPromptId === prompt.id) {
                                item.classList.add('selected');
                            }
                            
                            item.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${prompt.name}</div>
                                        <div class="prompt-meta">
                                            생성: ${new Date(prompt.created_at).toLocaleString()}
                                            ${prompt.updated_at !== prompt.created_at ? ' | 수정: ' + new Date(prompt.updated_at).toLocaleString() : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 0;" onclick="deletePrompt('${prompt.id}')" title="삭제" data-prompt-id="${prompt.id}">🗑️</button>
                                    </div>
                                </div>
                            `;
                            item.onclick = (e) => {
                                if (!e.target.closest('button')) {
                                    loadPromptContent(prompt);
                                }
                            };
                            listEl.appendChild(item);
                        });
                    }
                    
                } catch (error) {
                    console.error('프롬프트 로드 중 오류:', error);
                    
                    // 에러 메시지를 안전하게 추가
                    const promptItems = listEl.querySelectorAll('.prompt-item');
                    promptItems.forEach(item => item.remove());
                    
                    const errorMessage = document.createElement('div');
                    errorMessage.style.cssText = 'padding: 20px; text-align: center; color: #dc3545;';
                    errorMessage.textContent = '프롬프트 로드 중 오류가 발생했습니다.';
                    listEl.appendChild(errorMessage);
                } finally {
                    // 로딩 표시 제거
                    loadingEl.classList.remove('show');
                    console.log('loadPrompts() 완료');
                }
            }, 300);
        }

        // 프롬프트 내용 로드
        function loadPromptContent(prompt) {
            document.getElementById('prompt-name').value = prompt.name;
            document.getElementById('prompt-content').value = prompt.content;
            currentPromptId = prompt.id;
            
            // 버튼 가시성 업데이트
            updateButtonVisibility();
            
            // 목록에서 선택된 항목 시각적 표시 업데이트
            updateSelectedPrompt(prompt.id);
            
            showResult(`프롬프트 "${prompt.name}"을(를) 로드했습니다.`, 'success');
        }

        // 선택된 프롬프트 시각적 표시 업데이트
        function updateSelectedPrompt(selectedId) {
            const promptItems = document.querySelectorAll('.prompt-item');
            promptItems.forEach(item => {
                if (item.dataset.promptId === selectedId) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // 프롬프트 삭제
        function deletePrompt(promptId) {
            console.log('deletePrompt() 호출됨, ID:', promptId, '타입:', typeof promptId);
            
            if (confirm('정말로 이 프롬프트를 삭제하시겠습니까?')) {
                try {
                    // 로컬 스토리지에서 최신 데이터 로드
                    const stored = localStorage.getItem('savedPrompts');
                    savedPrompts = stored ? JSON.parse(stored) : [];
                    
                    console.log('삭제 대상 프롬프트들:', savedPrompts.map(p => ({ id: p.id, name: p.name, idType: typeof p.id })));
                    
                    const beforeCount = savedPrompts.length;
                    
                    // ID 타입 확인하여 적절한 비교 수행
                    savedPrompts = savedPrompts.filter(p => {
                        const match = p.id == promptId || p.id === promptId || String(p.id) === String(promptId);
                        console.log(`프롬프트 ${p.name}: ID ${p.id} (${typeof p.id}) vs ${promptId} (${typeof promptId}) -> ${match ? '삭제' : '유지'}`);
                        return !match;
                    });
                    
                    const afterCount = savedPrompts.length;
                    
                    console.log(`삭제 전: ${beforeCount}개, 삭제 후: ${afterCount}개`);
                    
                    if (beforeCount === afterCount) {
                        console.warn('삭제가 실행되지 않았습니다. ID가 일치하지 않을 수 있습니다.');
                        showResult('삭제할 프롬프트를 찾을 수 없습니다.', 'error');
                        return;
                    }
                    
                    localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
                    
                    // 현재 선택된 프롬프트가 삭제된 경우 초기화
                    if (currentPromptId == promptId) {
                        clearPrompt();
                    }
                    
                    // 목록 새로고침
                    loadPrompts();
                    
                    showResult('프롬프트가 삭제되었습니다.', 'success');
                    
                } catch (error) {
                    console.error('프롬프트 삭제 중 오류:', error);
                    showResult('프롬프트 삭제 중 오류가 발생했습니다.', 'error');
                }
            }
        }

        // 프롬프트 초기화
        function clearPrompt() {
            document.getElementById('prompt-name').value = '';
            document.getElementById('prompt-content').value = '';
            currentPromptId = null;
            
            // 버튼 가시성 업데이트
            updateButtonVisibility();
            
            // 선택된 항목 해제
            const promptItems = document.querySelectorAll('.prompt-item');
            promptItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            showResult('프롬프트가 초기화되었습니다.', 'success');
        }

        // 저장소 상태 디버깅
        function debugStorage() {
            console.log('=== 저장소 상태 디버깅 ===');
            
            try {
                const stored = localStorage.getItem('savedPrompts');
                const parsedPrompts = stored ? JSON.parse(stored) : [];
                
                console.log('로컬 스토리지 원본 데이터:', stored);
                console.log('파싱된 프롬프트 배열:', parsedPrompts);
                console.log('프롬프트 개수:', parsedPrompts.length);
                console.log('현재 선택된 프롬프트 ID:', currentPromptId);
                console.log('전역 savedPrompts 변수:', savedPrompts);
                
                let debugInfo = `저장소 디버그 정보:\n`;
                debugInfo += `- 프롬프트 개수: ${parsedPrompts.length}\n`;
                debugInfo += `- 현재 선택된 ID: ${currentPromptId || '없음'}\n`;
                debugInfo += `- 로컬 스토리지 크기: ${stored ? stored.length : 0} 문자\n\n`;
                
                if (parsedPrompts.length > 0) {
                    debugInfo += `저장된 프롬프트 목록:\n`;
                    parsedPrompts.forEach((prompt, index) => {
                        debugInfo += `${index + 1}. ${prompt.name} (ID: ${prompt.id})\n`;
                    });
                } else {
                    debugInfo += `저장된 프롬프트가 없습니다.\n`;
                }
                
                showResult(debugInfo, 'success');
                
            } catch (error) {
                console.error('저장소 디버깅 중 오류:', error);
                showResult(`저장소 디버깅 중 오류: ${error.message}`, 'error');
            }
        }

        // 프롬프트 테스트 실행
        async function testPrompt() {
            const prompt = document.getElementById('prompt-content').value.trim();
            const memo = document.getElementById('memo-input').value.trim();

            if (!prompt) {
                showResult('프롬프트를 입력해주세요.', 'error');
                return;
            }

            if (!memo) {
                showResult('테스트할 메모 내용을 입력해주세요.', 'error');
                return;
            }

            const loadingEl = document.getElementById('test-loading');
            loadingEl.classList.add('show');

            try {
                const response = await fetch('/api/memo/refine', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        memo: memo,
                        custom_prompt: prompt
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    console.log(result)
                    // 사용자 정의 프롬프트의 경우 raw_response와 전체 결과를 모두 표시
                    if (result.raw_response) {
                        const displayMessage = `=== AI 원본 응답 ===\n${result.raw_response}\n\n=== 전체 API 응답 ===\n${JSON.stringify(result, null, 2)}`;
                        showResult(displayMessage, 'success');
                    } else {
                        showResult(JSON.stringify(result, null, 2), 'success');
                    }
                } else {
                    showResult(`오류: ${result.detail || '알 수 없는 오류가 발생했습니다.'}`, 'error');
                }
            } catch (error) {
                showResult(`네트워크 오류: ${error.message}`, 'error');
            } finally {
                loadingEl.classList.remove('show');
            }
        }

        // 결과 표시
        function showResult(message, type = 'success') {
            const container = document.getElementById('result-container');
            const resultBox = document.createElement('div');
            resultBox.className = `result-box ${type}`;

            resultBox.textContent = message;

            container.innerHTML = '';
            container.appendChild(resultBox);
            
            // 결과 섹션으로 스크롤
            resultBox.scrollIntoView({ behavior: 'smooth' });
        }

        // 결과 초기화
        function clearResults() {
            const container = document.getElementById('result-container');
            container.innerHTML = `
                <p style="color: #6c757d; text-align: center; padding: 40px;">
                    프롬프트를 실행하면 결과가 여기에 표시됩니다.
                </p>
            `;
        }
    </script>
</body>
</html>