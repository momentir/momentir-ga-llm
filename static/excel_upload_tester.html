<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—‘ì…€ ì—…ë¡œë“œ LLM ì •ì œ í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #2f3640;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .file-upload-area.dragover {
            border-color: #667eea;
            background-color: #e3f2fd;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 14px;
            color: #adb5bd;
        }

        .selected-file {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .selected-file .file-name {
            font-weight: 600;
            color: #155724;
        }

        .selected-file .file-info {
            font-size: 12px;
            color: #6c757d;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            max-height: 600px;
            overflow-y: auto;
        }

        .success {
            border-left: 4px solid #2ecc71;
            background-color: #d5f4e6;
        }

        .error {
            border-left: 4px solid #e74c3c;
            background-color: #ffeaea;
        }

        .warning {
            border-left: 4px solid #f39c12;
            background-color: #fff5e1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
        }

        .progress-fill {
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .user-id-input {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .settings-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .settings-panel h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1em;
        }

        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .form-group input, .form-group select {
            height: 48px; /* ëª¨ë“  ì…ë ¥ í•„ë“œ ë†’ì´ í†µì¼ */
        }

        /* í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ìŠ¤íƒ€ì¼ */
        .prompt-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
            margin-bottom: 10px;
        }

        .prompt-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .prompt-item:hover {
            background-color: #e9ecef;
        }

        .prompt-item:last-child {
            border-bottom: none;
        }

        .prompt-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-weight: 600;
        }

        .prompt-item.selected:hover {
            background-color: #e3f2fd;
        }

        .prompt-meta {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .supported-fields {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .supported-fields h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .field-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 5px;
            font-size: 12px;
            color: #424242;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .settings-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ì—‘ì…€ ì—…ë¡œë“œ LLM ì •ì œ í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ</h1>
            <p>ë³´í—˜ì„¤ê³„ì‚¬ ê³ ê° ì—‘ì…€ ë°ì´í„°ì˜ LLM ê¸°ë°˜ ìë™ ì •ì œ ë° ë¶„ì„ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”</p>
        </div>

        <div class="main-content">
            <!-- í”„ë¡¬í”„íŠ¸ ë° ì„¤ì • ê´€ë¦¬ ì„¹ì…˜ -->
            <div class="card">
                <h2>âš™ï¸ LLM í”„ë¡¬í”„íŠ¸ ë° ì„¤ì •</h2>
                
                <div class="settings-panel">
                    <h3>ê¸°ë³¸ ì„¤ì •</h3>
                    <div class="settings-row">
                        <div class="form-group">
                            <label for="user-id">ì„¤ê³„ì‚¬ ID (í•„ìˆ˜)</label>
                            <input type="number" id="user-id" class="user-id-input" placeholder="ì˜ˆ: 1" value="1">
                            <small style="color: #6c757d;">í…ŒìŠ¤íŠ¸ìš© ì„¤ê³„ì‚¬ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                        </div>
                        <div class="form-group">
                            <label for="test-mode">í…ŒìŠ¤íŠ¸ ëª¨ë“œ</label>
                            <select id="test-mode">
                                <option value="standard">í‘œì¤€ ì²˜ë¦¬</option>
                                <option value="debug">ë””ë²„ê·¸ ëª¨ë“œ</option>
                                <option value="dry-run">ë¯¸ë¦¬ë³´ê¸° (ì €ì¥ ì•ˆí•¨)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="prompt-name">í”„ë¡¬í”„íŠ¸ ì´ë¦„ (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="prompt-name" placeholder="ì˜ˆ: ë§ì¶¤í˜• ì»¬ëŸ¼ ë§¤í•‘ í”„ë¡¬í”„íŠ¸">
                </div>

                <div class="form-group">
                    <label for="custom-prompt">ì»¤ìŠ¤í…€ ì»¬ëŸ¼ ë§¤í•‘ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="custom-prompt" placeholder="ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>

                <div class="form-group">
                    <button class="btn" onclick="savePrompt()">ğŸ’¾ í”„ë¡¬í”„íŠ¸ ì €ì¥</button>
                    <button class="btn btn-success" id="update-prompt-btn" onclick="updatePrompt()" style="display: none;">âœï¸í”„ë¡¬í”„íŠ¸ ìˆ˜ì •</button>
                    <button class="btn btn-secondary" onclick="loadDefaultPrompt()">ğŸ“‹ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ë¡œë“œ</button>
                    <button class="btn btn-secondary" onclick="clearPrompt()">ğŸ”„ ì´ˆê¸°í™”</button>
                </div>

                <div class="form-group">
                    <label>ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ ëª©ë¡</label>
                    <div class="prompt-list" id="prompt-list">
                        <div class="loading" id="prompt-loading">
                            <div class="spinner"></div>
                            ë¡œë”© ì¤‘...
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="loadPrompts()">ğŸ“‚ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <div class="supported-fields">
                    <h4>ğŸ” ì§€ì›í•˜ëŠ” ë°ì´í„° í•„ë“œ</h4>
                    <div class="field-list">
                        <div>â€¢ ê³ ê°ì´ë¦„ (name)</div>
                        <div>â€¢ ì—°ë½ì²˜ (contact)</div>
                        <div>â€¢ ì†Œì† (affiliation)</div>
                        <div>â€¢ ì„±ë³„ (gender)</div>
                        <div>â€¢ ìƒë…„ì›”ì¼ (date_of_birth)</div>
                        <div>â€¢ ê´€ì‹¬ì‚¬ (interests)</div>
                        <div>â€¢ ì¸ìƒì´ë²¤íŠ¸ (life_events)</div>
                        <div>â€¢ ë³´í—˜ìƒí’ˆì •ë³´ (insurance_products)</div>
                        <div>â€¢ ê³ ê°ìœ í˜• (customer_type)</div>
                        <div>â€¢ ì ‘ì ì±„ë„ (contact_channel)</div>
                        <div>â€¢ ì „í™”ë²ˆí˜¸ (phone)</div>
                        <div>â€¢ ì£¼ë¯¼ë²ˆí˜¸ (resident_number)</div>
                        <div>â€¢ ì£¼ì†Œ (address)</div>
                        <div>â€¢ ì§ì—… (job_title)</div>
                        <div>â€¢ ê³„ì¢Œì€í–‰ (bank_name)</div>
                        <div>â€¢ ê³„ì¢Œë²ˆí˜¸ (account_number)</div>
                        <div>â€¢ ì†Œê°œì (referrer)</div>
                        <div>â€¢ ìƒí’ˆëª… (product_name)</div>
                        <div>â€¢ ê°€ì…ê¸ˆì•¡ (coverage_amount)</div>
                        <div>â€¢ ê°€ì…ì¼ (subscription_date)</div>
                        <div>â€¢ ì¢…ë£Œì¼/ê°±ì‹ ì¼ (expiry_renewal_date)</div>
                        <div>â€¢ ìë™ì´ì²´ì¼ (auto_transfer_date)</div>
                        <div>â€¢ ì¦ê¶Œêµë¶€ (policy_issued)</div>
                    </div>
                </div>
            </div>

            <!-- ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="card">
                <h2>ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2>
                
                <div class="form-group">
                    <div class="file-upload-area" onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                        <div class="upload-icon">ğŸ“Š</div>
                        <div class="upload-text">í´ë¦­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜</div>
                        <div class="upload-hint">íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸ & ë“œë¡­í•˜ì„¸ìš”</div>
                        <div class="upload-hint">(ì§€ì› í˜•ì‹: .xlsx, .xls | ìµœëŒ€ 100MB)</div>
                    </div>
                    <div id="selected-file" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <button class="btn btn-warning" onclick="testColumnMapping()" disabled id="mapping-test-btn">1. ì»¬ëŸ¼ ë§¤í•‘ í…ŒìŠ¤íŠ¸</button>
                    <button class="btn btn-success" id="upload-btn" onclick="uploadExcelFile()" disabled>2. LLM ì •ì œ ì‹¤í–‰</button>
                    <button class="btn btn-secondary" onclick="clearFile()">ğŸ—‘ï¸ íŒŒì¼ ì´ˆê¸°í™”</button>
                </div>

                <div class="loading" id="upload-loading">
                    <div class="spinner"></div>
                    <div id="upload-status">LLMì´ ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
                    <div class="progress-bar" style="margin-top: 15px;">
                        <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div class="results-section">
            <div class="card">
                <h2>ğŸ“Š LLM ì •ì œ ê²°ê³¼</h2>
                <div id="result-container">
                    <p style="color: #6c757d; text-align: center; padding: 40px;">
                        ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  LLM ì •ì œë¥¼ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let uploadProgress = 0;
        
        // í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ìš© ì „ì—­ ë³€ìˆ˜
        let savedPrompts = [];
        let currentPromptId = null;

        // ê¸°ë³¸ ì»¬ëŸ¼ ë§¤í•‘ í”„ë¡¬í”„íŠ¸
        const DEFAULT_MAPPING_PROMPT = `ë‹¹ì‹ ì€ ë³´í—˜ì„¤ê³„ì‚¬ì˜ ê³ ê° ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ ì—‘ì…€ ì»¬ëŸ¼ë“¤ì„ í‘œì¤€ í•„ë“œì™€ ì •í™•íˆ ë§¤í•‘í•´ì£¼ì„¸ìš”.

ë§¤í•‘ ê·œì¹™:
- ì„±ëª…, ê³ ê°ëª…, ì´ë¦„, ê³ ê°ì´ë¦„ â†’ name
- ì „í™”, ì—°ë½ì²˜, í•¸ë“œí°, í•¸ë“œí°ë²ˆí˜¸, ì „í™”ë²ˆí˜¸ â†’ contact ë˜ëŠ” phone (ì „í™”ë²ˆí˜¸ì¸ ê²½ìš°)
- íšŒì‚¬, ì†Œì†, ì§ì¥, ê¸°ê´€ â†’ affiliation
- ì„±ë³„ â†’ gender
- ìƒë…„ì›”ì¼, ìƒì¼, ì¶œìƒì¼ â†’ date_of_birth
- ê´€ì‹¬ì‚¬, ì·¨ë¯¸, ê´€ì‹¬ë¶„ì•¼ â†’ interests
- ì¸ìƒì´ë²¤íŠ¸, ìƒí™œì´ë²¤íŠ¸, ì´ë²¤íŠ¸ â†’ life_events
- ë³´í—˜ìƒí’ˆì •ë³´, ê¸°ì¡´ë³´í—˜, ë³´ìœ ë³´í—˜ â†’ insurance_products
- ë¶„ë¥˜, ìœ í˜•, ê³ ê°ìœ í˜• â†’ customer_type
- ê²½ë¡œ, ì ‘ì , ì±„ë„ â†’ contact_channel
- í•¸ë“œí°, ì „í™”ë²ˆí˜¸, íœ´ëŒ€í° â†’ phone (ì „í™”ë²ˆí˜¸ ì „ìš©)
- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ì£¼ë¯¼ë²ˆí˜¸ â†’ resident_number
- ê±°ì£¼ì§€, ì£¼ì†Œ â†’ address
- ì§ì¥, ì§ì—… â†’ job_title
- ë³´í—˜ìƒí’ˆ, ìƒí’ˆëª…, ê°€ì…ìƒí’ˆ, ë³´í—˜ëª… â†’ product_name
- ë³´ì¥ì•¡, ê°€ì…ê¸ˆì•¡, ë³´ì¥ê¸ˆì•¡ â†’ coverage_amount
- ê³„ì•½ì¼, ê°€ì…ì¼ â†’ subscription_date
- ê°±ì‹ ì¼, ë§Œë£Œì¼, ì¢…ë£Œì¼ â†’ expiry_renewal_date
- ì´ì²´ì¼, ë‚©ì…ì¼ â†’ auto_transfer_date
- ì¦ê¶Œë°œê¸‰, ì¦ê¶Œêµë¶€ â†’ policy_issued
- ì€í–‰, ê³„ì¢Œì€í–‰ â†’ bank_name
- ê³„ì¢Œ, ê³„ì¢Œë²ˆí˜¸ â†’ account_number
- ì†Œê°œì, ì¶”ì²œì¸ â†’ referrer

ì •í™•íˆ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "mapping": {
    "ì—‘ì…€ì»¬ëŸ¼ëª…": "í‘œì¤€í•„ë“œëª…"
  },
  "confidence_score": 0.95
}`;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileUpload();
            loadPrompts();
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ì´ˆê¸°í™”
        function initializeFileUpload() {
            const uploadArea = document.querySelector('.file-upload-area');
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({target: {files: files}});
                }
            });
        }

        // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // íŒŒì¼ íƒ€ì… ê²€ì¦
            const allowedTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // xlsx
                'application/vnd.ms-excel' // xls
            ];

            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
                showResult('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .xlsx ë˜ëŠ” .xls íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            // íŒŒì¼ í¬ê¸° ê²€ì¦ (100MB)
            if (file.size > 100 * 1024 * 1024) {
                showResult('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ 100MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            selectedFile = file;

            // ì„ íƒëœ íŒŒì¼ í‘œì‹œ
            const selectedFileDiv = document.getElementById('selected-file');
            selectedFileDiv.innerHTML = `
                <div class="selected-file">
                    <div class="file-name">ğŸ“Š ${file.name}</div>
                    <div class="file-info">í¬ê¸°: ${formatFileSize(file.size)} | ìˆ˜ì •ì¼: ${new Date(file.lastModified).toLocaleString()}</div>
                </div>
            `;
            selectedFileDiv.style.display = 'block';

            // ë²„íŠ¼ í™œì„±í™”
            document.getElementById('upload-btn').disabled = false;
            document.getElementById('mapping-test-btn').disabled = false;

            showResult(`íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤: ${file.name}`, 'success');
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
        function loadDefaultPrompt() {
            document.getElementById('custom-prompt').value = DEFAULT_MAPPING_PROMPT;
            showResult('ê¸°ë³¸ ì»¬ëŸ¼ ë§¤í•‘ í”„ë¡¬í”„íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”
        function clearPrompt() {
            document.getElementById('custom-prompt').value = '';
            document.getElementById('prompt-name').value = '';
            currentPromptId = null;
            updatePromptButtonVisibility();
            
            // ì„ íƒëœ í•­ëª© í•´ì œ
            const promptItems = document.querySelectorAll('.prompt-item');
            promptItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            showResult('í”„ë¡¬í”„íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // í”„ë¡¬í”„íŠ¸ ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
        function updatePromptButtonVisibility() {
            const updateBtn = document.getElementById('update-prompt-btn');
            if (currentPromptId) {
                updateBtn.style.display = 'inline-block';
            } else {
                updateBtn.style.display = 'none';
            }
        }

        // ìƒˆ í”„ë¡¬í”„íŠ¸ ì €ì¥
        function savePrompt() {
            const name = document.getElementById('prompt-name').value.trim() || 'ì´ë¦„ì—†ëŠ” í”„ë¡¬í”„íŠ¸';
            const content = document.getElementById('custom-prompt').value.trim();

            if (!content) {
                showResult('í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
                const stored = localStorage.getItem('columnMappingPrompts');
                savedPrompts = stored ? JSON.parse(stored) : [];
                
                // í•­ìƒ ìƒˆë¡œìš´ IDë¡œ í”„ë¡¬í”„íŠ¸ ìƒì„±
                const promptId = Date.now().toString();
                const prompt = {
                    id: promptId,
                    name: name,
                    content: content,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                savedPrompts.push(prompt);
                localStorage.setItem('columnMappingPrompts', JSON.stringify(savedPrompts));
                
                showResult(`í”„ë¡¬í”„íŠ¸ "${name}"ì´(ê°€) ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨
                loadPrompts();
                
                // ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ë¥¼ í˜„ì¬ ì„ íƒìœ¼ë¡œ ì„¤ì •
                currentPromptId = promptId;
                updatePromptButtonVisibility();
                
            } catch (error) {
                console.error('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                showResult('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •
        function updatePrompt() {
            const name = document.getElementById('prompt-name').value.trim() || 'ì´ë¦„ì—†ëŠ” í”„ë¡¬í”„íŠ¸';
            const content = document.getElementById('custom-prompt').value.trim();

            if (!content) {
                showResult('í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!currentPromptId) {
                showResult('ìˆ˜ì •í•  í”„ë¡¬í”„íŠ¸ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
                const stored = localStorage.getItem('columnMappingPrompts');
                savedPrompts = stored ? JSON.parse(stored) : [];
                
                const existingIndex = savedPrompts.findIndex(p => p.id === currentPromptId);
                
                if (existingIndex >= 0) {
                    // ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ ìˆ˜ì • - created_at ìœ ì§€
                    const prompt = {
                        ...savedPrompts[existingIndex],
                        name: name,
                        content: content,
                        updated_at: new Date().toISOString()
                    };
                    savedPrompts[existingIndex] = prompt;

                    localStorage.setItem('columnMappingPrompts', JSON.stringify(savedPrompts));
                    
                    showResult(`í”„ë¡¬í”„íŠ¸ "${name}"ì´(ê°€) ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    
                    // ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨
                    loadPrompts();
                } else {
                    showResult('ìˆ˜ì •í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
                
            } catch (error) {
                console.error('í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
                showResult('í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ë¡œë“œ
        function loadPrompts() {
            const listEl = document.getElementById('prompt-list');
            const loadingEl = document.getElementById('prompt-loading');
            
            if (!listEl || !loadingEl) return;
            
            // ë¡œë”© í‘œì‹œ
            loadingEl.classList.add('show');
            
            setTimeout(() => {
                try {
                    const stored = localStorage.getItem('columnMappingPrompts');
                    savedPrompts = stored ? JSON.parse(stored) : [];
                    
                    // ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ ì•„ì´í…œë“¤ë§Œ ì œê±°
                    const promptItems = listEl.querySelectorAll('.prompt-item');
                    promptItems.forEach(item => item.remove());
                    
                    // ê¸°ì¡´ ë©”ì‹œì§€ë“¤ ì œê±°
                    const messages = listEl.querySelectorAll('div:not(.loading):not(#prompt-loading)');
                    messages.forEach(msg => {
                        if (!msg.classList.contains('prompt-item') && msg.id !== 'prompt-loading') {
                            msg.remove();
                        }
                    });
                    
                    if (savedPrompts.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.style.cssText = 'padding: 20px; text-align: center; color: #6c757d;';
                        emptyMessage.textContent = 'ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        listEl.appendChild(emptyMessage);
                    } else {
                        savedPrompts.forEach(prompt => {
                            const item = document.createElement('div');
                            item.className = 'prompt-item';
                            item.dataset.promptId = prompt.id;
                            
                            // í˜„ì¬ ì„ íƒëœ í”„ë¡¬í”„íŠ¸ì¸ì§€ í™•ì¸í•˜ì—¬ selected í´ë˜ìŠ¤ ì¶”ê°€
                            if (currentPromptId && currentPromptId === prompt.id) {
                                item.classList.add('selected');
                            }
                            
                            item.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${prompt.name}</div>
                                        <div class="prompt-meta">
                                            ìƒì„±: ${new Date(prompt.created_at).toLocaleString()}
                                            ${prompt.updated_at !== prompt.created_at ? ' | ìˆ˜ì •: ' + new Date(prompt.updated_at).toLocaleString() : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px; margin: 0;" onclick="deletePrompt('${prompt.id}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                                    </div>
                                </div>
                            `;
                            item.onclick = (e) => {
                                if (!e.target.closest('button')) {
                                    loadPromptContent(prompt);
                                }
                            };
                            listEl.appendChild(item);
                        });
                    }
                    
                } catch (error) {
                    console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                    
                    const promptItems = listEl.querySelectorAll('.prompt-item');
                    promptItems.forEach(item => item.remove());
                    
                    const errorMessage = document.createElement('div');
                    errorMessage.style.cssText = 'padding: 20px; text-align: center; color: #dc3545;';
                    errorMessage.textContent = 'í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    listEl.appendChild(errorMessage);
                } finally {
                    // ë¡œë”© í‘œì‹œ ì œê±°
                    loadingEl.classList.remove('show');
                }
            }, 300);
        }

        // í”„ë¡¬í”„íŠ¸ ë‚´ìš© ë¡œë“œ
        function loadPromptContent(prompt) {
            document.getElementById('prompt-name').value = prompt.name;
            document.getElementById('custom-prompt').value = prompt.content;
            currentPromptId = prompt.id;
            
            // ë²„íŠ¼ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
            updatePromptButtonVisibility();
            
            // ëª©ë¡ì—ì„œ ì„ íƒëœ í•­ëª© ì‹œê°ì  í‘œì‹œ ì—…ë°ì´íŠ¸
            updateSelectedPrompt(prompt.id);
            
            showResult(`í”„ë¡¬í”„íŠ¸ "${prompt.name}"ì„(ë¥¼) ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ ì‹œê°ì  í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSelectedPrompt(selectedId) {
            const promptItems = document.querySelectorAll('.prompt-item');
            promptItems.forEach(item => {
                if (item.dataset.promptId === selectedId) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // í”„ë¡¬í”„íŠ¸ ì‚­ì œ
        function deletePrompt(promptId) {
            if (confirm('ì •ë§ë¡œ ì´ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ
                    const stored = localStorage.getItem('columnMappingPrompts');
                    savedPrompts = stored ? JSON.parse(stored) : [];
                    
                    const beforeCount = savedPrompts.length;
                    savedPrompts = savedPrompts.filter(p => p.id !== promptId);
                    const afterCount = savedPrompts.length;
                    
                    if (beforeCount === afterCount) {
                        showResult('ì‚­ì œí•  í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    localStorage.setItem('columnMappingPrompts', JSON.stringify(savedPrompts));
                    
                    // í˜„ì¬ ì„ íƒëœ í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œëœ ê²½ìš° ì´ˆê¸°í™”
                    if (currentPromptId === promptId) {
                        clearPrompt();
                    }
                    
                    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadPrompts();
                    
                    showResult('í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    
                } catch (error) {
                    console.error('í”„ë¡¬í”„íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                    showResult('í”„ë¡¬í”„íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        }

        // íŒŒì¼ ì´ˆê¸°í™”
        function clearFile() {
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('selected-file').style.display = 'none';
            document.getElementById('upload-btn').disabled = true;
            document.getElementById('mapping-test-btn').disabled = true;
            showResult('ì„ íƒëœ íŒŒì¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì»¬ëŸ¼ ë§¤í•‘ í…ŒìŠ¤íŠ¸
        async function testColumnMapping() {
            if (!selectedFile) {
                showResult('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const userId = document.getElementById('user-id').value;
            if (!userId) {
                showResult('ì„¤ê³„ì‚¬ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const loadingEl = document.getElementById('upload-loading');
            const statusEl = document.getElementById('upload-status');
            
            statusEl.textContent = 'LLMì´ ì—‘ì…€ ì»¬ëŸ¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            loadingEl.classList.add('show');

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('user_id', userId);

                const customPrompt = document.getElementById('custom-prompt').value.trim();
                if (customPrompt) {
                    formData.append('custom_prompt', customPrompt);
                }

                const response = await fetch('/api/customer/column-mapping', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    const displayMessage = `=== ì»¬ëŸ¼ ë§¤í•‘ ë¶„ì„ ê²°ê³¼ ===\n${JSON.stringify(result, null, 2)}`;
                    showResult(displayMessage, 'success');
                } else {
                    showResult(`ì˜¤ë¥˜: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`, 'error');
                }

            } catch (error) {
                showResult(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                loadingEl.classList.remove('show');
            }
        }

        // ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ë° LLM ì •ì œ
        async function uploadExcelFile() {
            if (!selectedFile) {
                showResult('ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const userId = document.getElementById('user-id').value;
            if (!userId) {
                showResult('ì„¤ê³„ì‚¬ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const loadingEl = document.getElementById('upload-loading');
            const statusEl = document.getElementById('upload-status');
            const progressFill = document.getElementById('progress-fill');
            
            statusEl.textContent = 'LLMì´ ì—‘ì…€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ì •ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            loadingEl.classList.add('show');

            // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜
            simulateProgress();

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('user_id', userId);

                const testMode = document.getElementById('test-mode').value;
                if (testMode !== 'standard') {
                    formData.append('test_mode', testMode);
                }

                const customPrompt = document.getElementById('custom-prompt').value.trim();
                if (customPrompt) {
                    formData.append('custom_prompt', customPrompt);
                }

                const response = await fetch('/api/customer/excel-upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // ì§„í–‰ë¥  100% ì™„ë£Œ
                progressFill.style.width = '100%';
                progressFill.textContent = 'ì™„ë£Œ!';

                if (response.ok) {
                    const displayMessage = formatUploadResult(result);
                    showResult(displayMessage, 'success');
                } else {
                    showResult(`ì˜¤ë¥˜: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`, 'error');
                }

            } catch (error) {
                showResult(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    loadingEl.classList.remove('show');
                    progressFill.style.width = '0%';
                    progressFill.textContent = '0%';
                    uploadProgress = 0;
                }, 1000);
            }
        }

        // ì—…ë¡œë“œ ê²°ê³¼ í¬ë§·íŒ…
        function formatUploadResult(result) {
            let message = '=== LLM ì—‘ì…€ ë°ì´í„° ì •ì œ ê²°ê³¼ ===\n\n';
            
            // ê¸°ë³¸ í†µê³„
            message += `ğŸ“Š ì²˜ë¦¬ í†µê³„:\n`;
            message += `- ì²˜ë¦¬ëœ í–‰ ìˆ˜: ${result.processed_rows || 0}\n`;
            message += `- ìƒì„±ëœ ê³ ê° ìˆ˜: ${result.created_customers || 0}\n`;
            message += `- ìˆ˜ì •ëœ ê³ ê° ìˆ˜: ${result.updated_customers || 0}\n`;
            message += `- ì´ ìƒí’ˆ ìˆ˜: ${result.total_products || 0}\n`;
            message += `- ìƒì„±ëœ ìƒí’ˆ ìˆ˜: ${result.created_products || 0}\n`;
            message += `- ì‹¤íŒ¨í•œ ìƒí’ˆ ìˆ˜: ${result.failed_products || 0}\n\n`;

            // ì„±ëŠ¥ ì§€í‘œ
            if (result.mapping_success_rate !== undefined) {
                message += `ğŸ¯ ë§¤í•‘ ì„±ê³µë¥ : ${(result.mapping_success_rate * 100).toFixed(1)}%\n`;
            }
            
            if (result.processing_time_seconds) {
                message += `â±ï¸  ì²˜ë¦¬ ì‹œê°„: ${result.processing_time_seconds.toFixed(2)}ì´ˆ\n\n`;
            }

            // ì˜¤ë¥˜ ì •ë³´
            if (result.errors && result.errors.length > 0) {
                message += `âš ï¸  ì˜¤ë¥˜ ëª©ë¡ (${result.errors.length}ê±´):\n`;
                result.errors.slice(0, 10).forEach((error, index) => {
                    message += `${index + 1}. ${error}\n`;
                });
                if (result.errors.length > 10) {
                    message += `... ê·¸ ì™¸ ${result.errors.length - 10}ê°œ ì˜¤ë¥˜\n`;
                }
                message += '\n';
            }

            // ì „ì²´ ì‘ë‹µ
            message += `=== ì „ì²´ API ì‘ë‹µ ===\n${JSON.stringify(result, null, 2)}`;
            
            return message;
        }

        // ì§„í–‰ë¥  ì‹œë®¬ë ˆì´ì…˜
        function simulateProgress() {
            const progressFill = document.getElementById('progress-fill');
            const statusEl = document.getElementById('upload-status');
            
            const steps = [
                { progress: 20, message: 'íŒŒì¼ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤...' },
                { progress: 40, message: 'LLMì´ ì»¬ëŸ¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...' },
                { progress: 60, message: 'ë°ì´í„°ë¥¼ ì •ì œí•˜ê³  ìˆìŠµë‹ˆë‹¤...' },
                { progress: 80, message: 'ê³ ê° ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...' },
                { progress: 90, message: 'ê°€ì…ìƒí’ˆ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤...' }
            ];

            let currentStep = 0;
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    progressFill.style.width = step.progress + '%';
                    progressFill.textContent = step.progress + '%';
                    statusEl.textContent = step.message;
                    uploadProgress = step.progress;
                    currentStep++;
                } else {
                    clearInterval(interval);
                }
            }, 1500);
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult(message, type = 'success') {
            const container = document.getElementById('result-container');
            const resultBox = document.createElement('div');
            resultBox.className = `result-box ${type}`;
            resultBox.textContent = message;

            container.innerHTML = '';
            container.appendChild(resultBox);
            
            // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultBox.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>